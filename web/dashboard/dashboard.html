<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Task Dashboard</title>
<link rel="stylesheet" href="/style/style.css">

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <h2>Task Dashboard</h2>
  <p>Your Slack ID: <b>{{ user_id }}</b></p>
  <div id="tasks"></div>

  <script>
    const userId = "{{ user_id }}";
    const socket = io();
    socket.on("task_update", loadTasks);

    function formatDateTime(isoStr) {
      if (!isoStr || isoStr === "-") return "-";
      const dt = new Date(isoStr);
      if (isNaN(dt.getTime())) return "-";
      const day = String(dt.getDate()).padStart(2, "0");
      const month = String(dt.getMonth() + 1).padStart(2, "0");
      const year = dt.getFullYear();
      let hours = dt.getHours();
      const minutes = String(dt.getMinutes()).padStart(2, "0");
      const ampm = hours >= 12 ? "PM" : "AM";
      hours = hours % 12;
      if (hours === 0) hours = 12;
      hours = String(hours).padStart(2, "0");
      return `${day}/${month}/${year} ${hours}:${minutes} ${ampm}`;
    }

    function loadTasks() {
      fetch(`/api/tasks/${userId}`)
        .then(r => r.json())
        .then(tasks => {
          if (!tasks.length) {
            document.getElementById("tasks").innerHTML = "<p>No tasks found.</p>";
            return;
          }

          const html = `
            <table>
              <thead>
                <tr>
                  <th>Sr. No.</th>
                  <th>Task ID</th>
                  <th>Creator</th>
                  <th>Assigned To</th>
                  <th>Assigned Date</th>
                  <th>Task</th>
                  <th>Status</th>
                  <th>Due</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                ${tasks.map((t, index) => `
                  <tr>
                    <td>${index + 1}</td>
                    <td>${t.id}</td>
                    <td>${t.creator}</td>
                    <td>${t.assigned_to}</td>
                    <td>${formatDateTime(t.created_at)}</td>
                    <td>${t.text}</td>
                    <td>${
                      t.done
                        ? '<span class="done">Done</span>'
                        : '<span class="pending">Pending</span>'
                    }</td>
                    <td>${formatDateTime(t.due)}</td>
                    <td>${
                      !t.done
                        ? `<button onclick="markComplete(${t.id})">Complete</button>`
                        : ""
                    }</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>`;
          document.getElementById("tasks").innerHTML = html;
        })
        .catch(err => {
          console.error("Error loading tasks:", err);
        });
    }

    async function markComplete(id) {
  await fetch("/api/complete_task", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ task_id: id, user_id: userId })
  });
  loadTasks(); // refresh table after marking complete
}


    loadTasks();
  </script>
</body>
</html>
